# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: HA Mode
templates:
  - templates/statefulset.yaml
values:
- ../values.yaml
- fixtures/default_values.yaml

tests:
  - it: deploys one replica by default
    set: 
      highAvailabilityMode.enabled: false
    asserts:
      - equal:
          path: spec.replicas
          value: 1
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: BROKER_HA_MODE_ENABLED
            value: "false"

  - it: configures multiple replicas
    set:
      highAvailabilityMode.replicaCount: 2
      highAvailabilityMode.enabled: true
    asserts:
      - equal:
          path: spec.replicas
          value: 2
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: BROKER_HA_MODE_ENABLED
            value: "true"

  - it: does not allow more than 4 replicas
    set:
      highAvailabilityMode.replicaCount: 5
      highAvailabilityMode.enabled: true
    asserts:
      - failedTemplate: {}

  - it: does not allow setting 1 replica in HA mode
    set:
      highAvailabilityMode.replicaCount: 1
      highAvailabilityMode.enabled: true
    asserts:
      - failedTemplate: {}
