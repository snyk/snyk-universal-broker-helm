# tests/test-secret-statefulset.yaml

suite: "Snyk Broker Helm Chart Tests"
templates:
  - secret.yaml
  - statefulset.yaml

tests:
- it: should create a Secret if existingAuthSecret is not provided
  template: secret.yaml
  set:
    credentialReferences:
      mygithubtoken: "test-token"
      githubAppPrivateKey: |-
        -----BEGIN RSA PRIVATE KEY-----
        FAKE KEY DATA
        -----END RSA PRIVATE KEY-----
  asserts:
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: RELEASE-NAME-snyk-universal-broker-platform-auth
        template: templates/statefulset.yaml
      - equal:
          path: stringData["mygithubtoken"]
          value: "test-token"
        template: templates/secret.yaml
      - equal:
          path: stringData["githubAppPrivateKey"]
          value: |-
            -----BEGIN RSA PRIVATE KEY-----
            FAKE KEY DATA
            -----END RSA PRIVATE KEY-----
        template: templates/secret.yaml